<script setup>
import Toast from "@/helper";
import axios from "axios";
import { onMounted, ref, watch } from "vue";
import { computed } from "vue";
import { useRouter, useRoute } from "vue-router";
import { api } from "@/utils/axios";

import { useSettingStore } from "@/store/setting";
import { debounce } from "lodash";

const settingStore = useSettingStore();

const campus_id = ref(settingStore.campus_id);
const route = useRoute();

const router = useRouter();

const editMode = ref(false);

const isloading = ref(false);

const form = ref({
  id: "",
  kh_name: "",
  en_name: "",
  gender: 1,
  dob: "",
  phone: "",
  email: "",
  facebookName: "",
  national: "",
  description: "",
  photo_path: "",
  new_photo_path: "",
  profession: "",
  village_address: "",
  commune_address: "",
  district_address: "",
  province_address: "",
  village_birth: "",
  commune_birth: "",
  district_birth: "",
  province_birth: "",
  campus_id: campus_id.value,
});

const resetForm = () => {
  form.value = {
    id: "",
    kh_name: "",
    en_name: "",
    gender: 1,
    dob: "",
    phone: "",
    email: "",
    facebookName: "",
    national: "",
    description: "",
    photo_path: "",
    new_photo_path: "",
    profession: "",
    village_address: "",
    commune_address: "",
    district_address: "",
    province_address: "",
    village_birth: "",
    commune_birth: "",
    district_birth: "",
    province_birth: "",
    campus_id: campus_id.value,
  };
};

watch(
  () => settingStore.campus_id,
  (newVal) => {
    campus_id.value = newVal;
    form.value.campus_id = campus_id.value;
  }
);

const nation = ref([
  {
    name: "·ûÅ·üí·ûò·üÇ·ûö",
  },
  {
    name: "·ûá·ûì·ûá·û∂·ûè·û∑",
  },
]);

const gender = ref([
  {
    name: "·ûî·üí·ûö·ûª·ûü",
    id: 1,
  },
  {
    name: "·ûü·üí·ûö·û∏",
    id: 2,
  },
]);

const rules = ref({
  required: (value) => !!value || "Field is required",
});

// Filter rooms where status = 0

const refInputEl = ref("");

const handleFileUpload = (e) => {
  let file = e.target.files[0];
  if (form.value.id) {
    form.value.new_photo_path = file;
  } else {
    form.value.photo_path = file;
  }
};

const getPhoto = () => {
  const isBlobOrFile = (value) =>
    value instanceof Blob || value instanceof File;
  if (form.value.id) {
    if (form.value.new_photo_path && form.value.new_photo_path !== "") {
      return isBlobOrFile(form.value.new_photo_path)
        ? URL.createObjectURL(form.value.new_photo_path)
        : "";
    } else {
      return form.value.photo_path
        ? "https://iconic.disreportcard.com/storage/" + form.value.photo_path
        : "";
    }
  } else {
    return isBlobOrFile(form.value.photo_path)
      ? URL.createObjectURL(form.value.photo_path)
      : "";
  }
};

const addTeacher = async () => {
  isloading.value = true;
  console.log("teacher", form.value);
  try {
    await api
      .post("/add_teacher", form.value, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      })
      .then((res) => {
        Toast.fire({
          title: res.data.message,
          icon: "success",
        });
      });
    resetForm();
    router.push("teacher");
  } catch (error) {
    Toast.fire({
      title: error.response.data.message,
      icon: "error",
    });
  } finally {
    isloading.value = false;
  }
};

const updateTeacher = async () => {
  isloading.value = true;
  try {
    await api
      .post("/updateTeacher", form.value, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      })
      .then((res) => {
        Toast.fire({
          title: res.data.message,
          icon: "success",
        });
      });
    router.push({
      name: "TeacherList",
    });
  } catch (error) {
    console.log(error);
  } finally {
    isloading.value = false;
  }
};

const getOneTeacher = async () => {
  try {
    await api.post(`/getOneTeacher/${route.params.id}`).then((res) => {
      // Object.assign(form.value, res.data);
      form.value = res.data;
    });
  } catch (error) {
    console.log(error);
  }
};

const submit = () => {
  if (editMode.value) {
    updateTeacher();
  } else {
    addTeacher();
  }
};

onMounted(() => {
  if (route.params.id) {
    editMode.value = true;
    console.log(editMode.value);
    getOneTeacher();
  }
});
</script>
<template>
  <div>
    <v-card class="mt-5 pa-4 border border-2" elevation="0">
      <v-card-title class="customKhmerMoul text-green-darken-4"
        ><h3>·ûî·ûÑ·üí·ûÄ·ûæ·ûè·ûÇ·üí·ûö·ûº·ûî·ûÑ·üí·ûö·üÄ·ûì</h3></v-card-title
      >

      <v-card-text class="d-flex mt-3">
        <!-- üëâ Avatar -->
        <V-avatar
          rounded="lg"
          size="100"
          class="me-6 rounded-lg border-sm"
          :image="getPhoto()"
        />

        <!-- üëâ Upload Photo -->
        <form class="d-flex flex-column justify-center gap-5 customFont">
          <div class="d-flex flex-wrap">
            <VBtn
              color="orange mr-2"
              @click="refInputEl?.click()"
              variant="tonal"
            >
              <VIcon icon="mdi-upload" class="d-sm-none" />
              <span class="d-none d-sm-block">·ûî·ûâ·üí·ûÖ·ûº·ûõ·ûö·ûº·ûî·ûó·û∂·ûñ</span>
            </VBtn>

            <input
              ref="refInputEl"
              type="file"
              name="file"
              hidden
              @input="handleFileUpload"
            />

            <!-- <VBtn
              type="reset"
              color="error"
              variant="tonal"
              @click="resetAvatar"
            >
              <span class="d-none d-sm-block">·ûü·ûò·üí·û¢·û∂·ûè</span>
              <VIcon icon="mdi-delete-alert" class="d-sm-none" />
            </VBtn> -->
          </div>

          <p class="text-body-1 mb-0 mt-2">
            Allowed JPG, GIF or PNG. Max size of 800K
          </p>
        </form>
      </v-card-text>

      <v-divider></v-divider>

      <!-- <v-card-title class="text-primary">Personal Information </v-card-title> -->
      <v-card-text>
        <!-- üëâ Form -->
        <v-form class="customFont">
          <v-row>
            <!-- üëâ FullName Khmer -->
            <v-col md="3" cols="12" :height="50" sm="4">
              <VTextField
                placeholder="·ûë·û∂·ûÑ‚Äã ·ûè·üÅ·ûõ·û∂"
                label="·ûà·üí·ûò·üÑ·üá(·ûá·û∂·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö) *"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.kh_name"
              />
            </v-col>

            <!-- üëâ FullName English -->
            <v-col md="3" cols="12" sm="4">
              <VTextField
                placeholder="TEANG Tela"
                label="·ûà·üí·ûò·üÑ·üá(·ûá·û∂·ûó·û∂·ûü·û∂·û¢·ûÄ·üí·ûü·ûö·û°·û∂·ûè·û∂·üÜ·ûÑ) *"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.en_name"
              />
            </v-col>

            <!-- üëâ Gender -->
            <v-col md="2" cols="12" sm="2">
              <v-select
                placeholder="·ûî·üí·ûö·ûª·ûü"
                label="·ûó·üÅ·ûë *"
                variant="outlined"
                :items="gender"
                item-title="name"
                item-value="id"
                :rules="[rules.required]"
                density="compact"
                v-model="form.gender"
              />
            </v-col>

            <!-- üëâ National -->
            <v-col md="2" cols="12" sm="2">
              <VSelect
                placeholder="·ûÅ·üí·ûò·üÇ·ûö"
                :items="nation"
                item-title="name"
                item-value="name"
                label="·ûü·ûâ·üí·ûá·û∂·ûè·û∑ *"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.national"
              />
            </v-col>

            <!-- üëâ DataOfBirth -->
            <v-col md="2" cols="12" sm="3">
              <VTextField
                label="·ûê·üí·ûÑ·üÉ·ûÅ·üÇ·ûÜ·üí·ûì·û∂·üÜ·ûÄ·üÜ·ûé·ûæ·ûè *"
                variant="outlined"
                type="date"
                :rules="[rules.required]"
                density="compact"
                v-model="form.dob"
              />
            </v-col>

            <!-- üëâ village of Birth -->
            <v-col md="2" cols="12" sm="3">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûó·ûº·ûò·û∑·ûÄ·üÜ·ûé·ûæ·ûè"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.village_birth"
              />
            </v-col>
            <!-- üëâ commune of Birth -->
            <v-col md="2" cols="12" sm="3">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûÉ·ûª·üÜ/·ûü·ûÑ·üí·ûÄ·û∂·ûè·üã·ûÄ·üÜ·ûé·ûæ·ûè"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.commune_birth"
              />
            </v-col>
            <!-- üëâ district of Birth -->
            <v-col md="2" cols="12" sm="3">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûü·üí·ûö·ûª·ûÄ·ûÄ·üÜ·ûé·ûæ·ûè"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.district_birth"
              />
            </v-col>
            <!-- üëâ province of Birth -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûÅ·üÅ·ûè·üí·ûè·ûÄ·üÜ·ûé·ûæ·ûè"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.province_birth"
              />
            </v-col>

            <!-- üëâ Email -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="telateang@gmail.com"
                label="·û¢·ûª·û∏·ûò·üâ·üÇ·ûõ"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.email"
              />
            </v-col>

            <!-- üëâ PhoneNumber -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="096 2211 209"
                label="·ûõ·üÅ·ûÅ·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë *"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.phone"
              />
            </v-col>

            <!-- üëâ Address -->

            <!-- üëâvillage Address -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûó·ûº·ûò·û∑·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.village_address"
              />
            </v-col>
            <!-- üëâcomune Address -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûÉ·ûª·üÜ/·ûü·ûÑ·üí·ûÄ·û∂·ûè·üã·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.commune_address"
              />
            </v-col>

            <!-- üëâdistrict Address -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûü·üí·ûö·ûª·ûÄ·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.district_address"
              />
            </v-col>
            <!-- üëâprovince Address -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="·ûÄ·ûò·üí·ûò·ûÄ·ûö"
                label="·ûÅ·üÅ·ûè·üí·ûè·ûî·ûÖ·üí·ûÖ·ûª·ûî·üí·ûî·ûì·üí·ûì"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.province_address"
              />
            </v-col>

            <!-- üëâ Facebook -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="Eno"
                label="Facebook"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.facebookName"
              />
            </v-col>

            <!-- üëâ Profession -->
            <v-col md="2" cols="12" sm="4">
              <VTextField
                placeholder="·ûÅ·üí·ûò·üÇ·ûö, ·ûö·ûº·ûî, ·ûÇ·ûé·û∑·ûè"
                label="·ûá·üÜ·ûì·û∂·ûâ·ûö·ûî·ûü·üã·ûÇ·üí·ûö·ûº *"
                variant="outlined"
                :rules="[rules.required]"
                density="compact"
                v-model="form.profession"
              />
            </v-col>

            <!-- üëâ Description -->
            <v-col cols="12" md="12">
              <v-textarea
                clearable
                label="·ûÄ·ûè·üã·ûü·ûò·üí·ûÇ·û∂·ûõ·üã"
                row-height="25"
                rows="3"
                variant="outlined"
                auto-grow
                shaped
                v-model="form.description"
              ></v-textarea>
            </v-col>

            <!-- üëâ Form Actions -->
            <VCol cols="12" class="d-flex ga-4 justify-end">
              <VBtn variant="tonal" color="red" type="reset" @click="resetForm">
                ·ûü·ûò·üí·û¢·û∂·ûè
              </VBtn>
              <VBtn
                :loading="isloading"
                :disabled="isloading"
                @click="submit"
                color="green"
                variant="tonal"
                >·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ</VBtn
              >
            </VCol>
          </v-row>
        </v-form>
      </v-card-text>
    </v-card>
  </div>
</template>
